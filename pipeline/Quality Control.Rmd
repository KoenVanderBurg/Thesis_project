---
title: "CRC quality control"
date: 19/08/2021
output: html_documentj n  h
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(devtools)
library(ggbiplot)
library(readxl)
library(ggplot2)
```

# Quality Control

```{r, echo = FALSE, include=FALSE}

  setwd("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/input_data")
  #Loading in files
  sample_sheet <- read_excel("sample_sheet.xlsx")
  CRC_dataset <- read_excel("CRC_Stage-III_Salzburg-Cohort_Coded_Relapse-Data_fChristina.xlsx")

  #Merging two tables together, based on sample_ID/samplegetwd()\
  full_data <- merge (sample_sheet, CRC_dataset, by.x = "sample", by.y = "Sample ID")
  
  #Select the columns that we want to keep
  full_data =  subset(full_data, select = c("sample", "Sex\n[1=male; 2=female]", "Relapse within 3 years\n[0=No; 1=Yes]","Tumor Cell Content\n[minimum]","Tumor Cell Content\n[maximum]"))
  
  #Changing the column names for easier viewing
  colnames(full_data) <- c('sample','gender', 'response', 'min_tumor_cell_content','max_tumor_cell_content')
  
  #Remove spaces from sample column of the df table.
  full_data$sample <- gsub('\\s+', '', full_data$sample)
  
  #Creating a filter that shows us a minimum tumor cell content of either 50% or 25%.
  vars <- c("min_tumor_cell_content")
  cond <- c(50, 25)
  
  #Using the filter, can select the condition (50%,25%) for which we want to check.
  annotation_table <- full_data %>% filter(.data[[vars[[1]]]] >= cond[[1]])
  
  #write.table(annotation_table, file="Annotation_table", quote = F)
  
  #loading in gene count data set
  counts_table <- read_table("salmon.merged.gene_counts.tsv")
  
  #optimized viewing (removing _ from the gene count data set)
  colnames(counts_table) <- gsub("_", "", colnames(counts_table))
  
  #removing samples from gene_count_dataset that don't have the 50% tumor cell count
  counts_table <- subset(counts_table, select = c("geneid","genename", annotation_table$sample))
  
  #creating a sum of all the gene counts
  counts_table_sum <- counts_table[annotation_table$sample]
  counts_table_sum <- lapply(counts_table_sum, sum, 2)
  counts_table_sum <- t(as.data.frame(counts_table_sum))
  
  
  #bar plot for total counts_table_sum:
    #-remove samples that have a count below 200.000
  counts_table_sum <- counts_table_sum[counts_table_sum[, 1] >= 200000, ]
  counts_table_sum <- as.data.frame(counts_table_sum) 
  colnames(counts_table_sum) <- c("total_counts")



```

## Total count numbers

Barplot of total count for each of the samples. Samples have at least 200.00 counts over all the genes and contain at least 50% tumor cell content.

```{r barplot, echo = FALSE}
#Actual plotting of the barplot
gene_barplot <- ggplot(data = counts_table_sum)+ geom_bar(mapping = aes(x= reorder(rownames(counts_table_sum), -total_counts), y = total_counts), stat = "identity")
gene_barplot <- gene_barplot + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
gene_barplot + labs(y="Counts", x = "Samples")

```

## Tumor cell content

In this barplot the minimum tumor cell content is showed for all the samples.

```{r, echo=FALSE, include=FALSE}

#Filter out needed columns
response_df <- subset(annotation_table, select = c ("sample", "response", "min_tumor_cell_content"))
colnames(response_df) <- c("sample", "response", "min_tumor_cell_content")
response_df$response <- as.character(response_df$response)
response_df$response <- recode(response_df$response,"1" = "Relapse", "2" = "No relapse")

#sub-setting out samples with the lower counts
response_df <- response_df[response_df$sample %in% rownames(counts_table_sum),]

```

```{r Tumor cell content, echo=FALSE}
#Actual plotting of response barplot
response_barplot <- ggplot(data = response_df)+
  geom_bar(mapping = aes(x = reorder(sample, -min_tumor_cell_content), y = min_tumor_cell_content, fill = response), stat = "identity")
response_barplot <- response_barplot + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs (y = "Min tumor cell content", x = "Samples") +
  scale_fill_discrete(name = "Relapse", labels = c("Relapse", "No relapse"))

response_barplot
```

## PCA plotting

PCA plot to see if the two groups (relapse / no relapse) could be separated by PC1 and PC2. Sadly the two groups could not be seperated as seen by the ellipses.

```{r, echo=FALSE, include=FALSE}
#PCA plotting

#Removing samples <200.000
t_counts_table <- t(counts_table)
t_counts_table <- t_counts_table[rownames(t_counts_table) %in% rownames(counts_table_sum),]

counts_table <- counts_table
counts_table <- as.data.frame(counts_table[,-2])
rownames(counts_table) <- counts_table$geneid
counts_table <- counts_table[,-1]

counts_table <- t(counts_table)
counts_table <- as.data.frame(counts_table[rownames(counts_table) %in% rownames(t_counts_table),])
counts_table <- log(counts_table+1)
```

```{r PCA plot, echo = FALSE}
  
counts.pca <- prcomp(counts_table) # center =TRUE, scale. = TRUE)
ggbiplot(counts.pca, var.axes = FALSE, groups = response_df$response, ellipse = TRUE, )

```

```{r main_function}
quality_control()


```

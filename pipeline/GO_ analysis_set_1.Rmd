---
title: "GO analysis"
author: "Koen van der Burg"
date: "19/05/2021"
output: html_document
editor_options: 
chunk_output_type: inline
---
  
# GO Analysis
  
## Setup library

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(clusterProfiler)
library(enrichplot)
library(ggplot2)
library(R.utils)
library(DOSE)

R.utils::setOption("clusterProfiler.download.method","auto")

#Select organism
organism = "org.Hs.eg.db"
library(organism, character.only = TRUE)
```


```{r loading dataframe and prepare input, echo = FALSE, include = FALSE}
sig_down <- read.table("sigIHW_down.csv", header = TRUE)
sig_down <- data.frame(sig_down, row.names = sig_down$gene_id)                  
sig_down <- subset(sig_down, select = -(gene_id))  

write.csv(sig_down,sep="\t", quote=F, col.names=NA,
          file.path ("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/output_data"), "sigIHW_down.csv")

sig_down <- read.csv("sigIHW_down.csv", header = TRUE)


original_gene_list <- sig_down$log2FoldChange                                          
names(original_gene_list) <- sig_down$X                                         #name the vector
gene_list<-na.omit(original_gene_list)                                          #omit any NA values 
gene_list = sort(gene_list, decreasing = TRUE)                                  #sort the list in decreasing order (required for clusterProfiler)

```

```{r Gene set Enrichtment, echo= FALSE, include= FALSE}

gse <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "ENSEMBL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Hs.eg.db, 
             pAdjustMethod = "none")

```
 

```{r Enrichment Map, warning= FALSE, message = FALSE}
#Enrichment analysis plots
dotplot(gse, showCategory=10, split=".sign") + facet_grid(.~.sign)
cnetplot(gse, categorySize="pvalue", foldChange=gene_list, showCategory = 3)
ridgeplot(gse) + labs(x = "enrichment distribution")

compare_cluster_GO_emap <- enrichplot::pairwise_termsim(gse, semData = gse)
emapplot(compare_cluster_GO_emap, showCategory = 10)

```





```{r Prepare input KEGG, echo= FALSE, include=FALSE}
#convert gene IDs for gseKEGG function, lose some genes here because not all IDs will be converted
ids<-bitr(names(original_gene_list), fromType = "ENSEMBL", toType = "ENTREZID", OrgDb= "org.Hs.eg.db")

#remove duplicate IDS (here I use "ENSEMBL", but it should be whatever was selected as keyType)
ids = ids[!duplicated(ids[c("ENSEMBL")]),]

#create a new dataframe mapped_genes which has only the genes which were successfully mapped using the bitr function above
mapped_genes = sig_down[sig_down$X %in% ids$ENSEMBL,]

#create a new column in mapped_genes with the corresponding ENTREZ IDs
mapped_genes$Y = ids$ENTREZID

#create a vector of the gene unuiverse
kegg_gene_list <- mapped_genes$log2FoldChange

#cnme vector with ENTREZ ids
names(kegg_gene_list) <- mapped_genes$Y

#omit any NA values 
kegg_gene_list<-na.omit(kegg_gene_list)

#sort the list in decreasing order (required for clusterProfiler)
kegg_gene_list = sort(kegg_gene_list, decreasing = TRUE)

```

```{r Create gseKEGG object, echo=FALSE, include=FALSE}
kk2 <- gseKEGG(geneList     = kegg_gene_list,
               organism     = "hsa",
               nPerm        = 10000,
               minGSSize    = 0,
               maxGSSize    = 800,
               pvalueCutoff = 0.5,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
```

```{r Dotplot, warning= FALSE, message= FALSE}
#KEGG analysis plots
cnetplot(kk2, categorySize="pvalue", foldChange=gene_list)

compare_cluster_GO_KEGG <- enrichplot::pairwise_termsim(kk2, semData = kk2)
emapplot(compare_cluster_GO_KEGG, showCategory = 10)

dotplot(kk2, showCategory = 10, title = "Enriched Pathways" , split=".sign") + facet_grid(.~.sign)

```
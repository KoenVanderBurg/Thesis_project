---
title: "DE Analysis set 2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(RColorBrewer)
library(DEGreport)
library(ggplot2)
library(ggrepel)
library(devtools)
library(ggbiplot)
library(readxl)
library(IHW)
library(pheatmap)
library(EnhancedVolcano)
library(DESeq2)
library(Glimma)
library(tidyr)
library(DOSE)

```

# Quality Control

```{r, echo = FALSE, include=FALSE}

setwd("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis/Innsbruck_project/Analysis/Saved_files")

full_data <- read_csv("READ_sample_info.csv")

#select the columns that we want to keep
full_data = full_datasubset(full_data, select = c("ID SPSS", "Gender", "Censor recurrence (0=recurrence, 1=no recurrence)"))
full_data = na.omit(full_data)

#changing the column names for easier viewing
colnames(full_data) <- c('sample', 'gender', 'response')

#write.table(full_data, file="Annotation_table", quote = F)

#loading in data set
counts_table <- read_table("salmon.merged.gene_counts2.tsv")    

#clean up row and column names  
counts_table = counts_table[,!grepl("^SN_",names(counts_table))]
colnames(counts_table) <- gsub("LW.", "", colnames(counts_table))
  
#Removing the first two columns of the counts_table set
counts_table_sum <- counts_table[,!grepl("^gene",names(counts_table))]

#Summing up the counts for each sample and transposing
counts_table_sum <- lapply(counts_table_sum, sum, 2)
counts_table_sum <- t(as.data.frame(counts_table_sum))


#Barplot for total counts_table_sum:
counts_table_sum <- counts_table_sum[counts_table_sum[, 1] >= 200000, ]
colnames(as.data.frame(counts_table_sum)) <- c("total_counts")
```


## Total count numbers
Barplot of total count for each of the samples. Samples have at least 200.00 counts over all the genes and contain at least 50% tumor cell content.


```{r barplot, echo = FALSE}
library(ggplot2)
#barplot
gene_barplot <- ggplot(data = counts_table_sum)+
  geom_bar(mapping = aes(x= reorder(rownames(counts_table_sum), -total_counts), y = total_counts), stat = "identity")
gene_barplot <- gene_barplot + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
gene_barplot + labs(y="Counts", x = "Samples")

``` 
## PCA plotting

PCA plot to see if the two groups (relapse / no relapse) could be seperated by PC1 and PC2. Sadly the two groups could not be seperated as seen by the ellipses. 
```{r, echo=FALSE, include=FALSE}
#PCA plotting
counts_table <- counts_table
counts_table <- as.data.frame(counts_table[,-2])
rownames(counts_table) <- counts_table$geneid
counts_table <- counts_table[,-1]

counts_table <- t(counts_table)
counts_table <- log(counts_table+1)
```


```{r PCA plot, echo = FALSE}
  
counts.pca <- prcomp(counts_table) # center =TRUE, scale. = TRUE)
ggbiplot(counts.pca, var.axes = FALSE, groups = full_data$relapse, ellipse = TRUE, )

```


#DE Analysis

## Reading in tables and modifying them
```{r CRC_loading,message=FALSE, warning=FALSE}

#Reading in Counts_table (>50% > 200.000)
CRC_counts_table <- counts_table
CRC_counts_table <- data.frame(CRC_counts_table, row.names = 1)
CRC_counts_table <- subset(CRC_counts_table, select = -c(gene_name))
colnames(CRC_counts_table) <- gsub("X", "", colnames(CRC_counts_table))
  
CRC_annotation <- full_data
CRC_counts_table_gene <- counts_table

CRC_annotation <- data.frame(CRC_annotation, row.names = CRC_annotation$sample)                         #set row_names -> sample names
CRC_annotation <- subset(CRC_annotation, select = -(sample))                                            #removal sample column

#Remove genes that have <2 total count in row
CRC_counts_table <- cbind(CRC_counts_table, total = rowSums(CRC_counts_table))                          #create column with total row_counts
CRC_counts_table <- subset(CRC_counts_table, total > 1)                                                 #remove rows(genes) with less than 2 counts
CRC_counts_table <- subset(CRC_counts_table, select = -(total))                                         #removal total column

#Ensemble version removal and removal of PAR_Y genes.
CRC_counts_table = CRC_counts_table[!grepl("_Y$",rownames(CRC_counts_table)),]                          #remove rows that end with the PAR_Y gene_id
CRC_counts_table$row_names <- row.names(CRC_counts_table)                                               #set row_names to column_names
CRC_counts_table$row_names <- gsub('(\\.).*', '', CRC_counts_table$row_names)                           #change row_names by removing ensemble ID
CRC_counts_table <- as.data.frame(CRC_counts_table, row.names = CRC_counts_table$row_names)             #convert back to original state
CRC_counts_table <- subset(CRC_counts_table, select = -(row_names))                                     #removal of row_names column
CRC_counts_table <- as.matrix(round(CRC_counts_table, 0))                                               #rounding counts to remove decimals

CRC_counts_table <- t(CRC_counts_table)
CRC_counts_table <- CRC_counts_table[match(rownames((CRC_annotation)), rownames((CRC_counts_table))),]
CRC_counts_table <- t(CRC_counts_table)

```


## Pre-check DESeq2 
```{r check, results='hide',message=FALSE, warning=FALSE}

#check if samples both in counts_table and annotation table, and amount of samples is equal.
table(colnames(CRC_counts_table) %in% rownames(CRC_annotation)) 
table(colnames(CRC_counts_table) == rownames(CRC_annotation))

```

## Creating DESeq2 object
Creating a DESeq2 object, from here we create a normalized counts table. The created dds object which is used later on for PCA plotting and heat map.
```{r normalized_counts,message=FALSE, warning=FALSE}

#creating DESeq2Dataset object and creating normalized_counts file for later use.
dds <- DESeqDataSetFromMatrix(countData = round(CRC_counts_table), colData = CRC_annotation, design = ~ response)
dds <- estimateSizeFactors(dds)                                                                         #median of ratios method of normalization
normalized_counts <- counts(dds, normalized=TRUE)                                                       #retrieving normalized counts matrix

#glimmaMDS(dds)                                                                                         #interactive plotting
#write.table(normalized_counts, file="normalized_counts_2.txt", sep="\t", quote=F, col.names=NA)        #creation of normalized_counts file
```


## PCA plots and correlation heatmap
Coloring on heat map needs to be changed. 
```{r QC,message=FALSE, warning=FALSE}

rld <- vst(dds, blind=TRUE)                                                                         #transform (r-log) counts for data visualization 
 
plotPCA(rld, intgroup="response")                                                                   #PCA plot: Response    
plotPCA(rld, intgroup="gender")                                                                     #PCA plot: Gender

##Heatmap
rld_mat <- assay(rld)                                                                               #extract the r-log matrix from the object
rld_cor <- cor(rld_mat)                                                                             #compute pairwise correlation values
CRC_annotation_heatmap <- subset(CRC_annotation, select = (response))                               #getting response subset for heat map
pheatmap(rld_cor, annotation_col = CRC_annotation_heatmap, main = "Pairwise correlation values", )  #plot heat map using the correlation matrix + metadata object
```

## DESeq2 analysis
Running the DESeq2 analysis, results derived from Independent Hypothesis Testing (IHW), using a log fold shrinkage. 
```{r DESeq2,message=FALSE, warning=FALSE}

resIHW <- results(dds, filterFun = ihw)                                                     #extracting results using IHW
resIHW_unshrunken <- resIHW                                                                 #save copy of non shrunken results
resIHW <- lfcShrink(dds, coef= "response" , type = "normal")                                #applying log fold change shrinkage / applyNames(dds)
```

## Dispersion and MA plots
```{r MAplot,message=FALSE, warning=FALSE}
#Plot dispersion estimates
plotDispEsts(dds, main = "Dispersion plot")

#MA Plot, colored genes are identified as significantly DE
plotMA(resIHW_unshrunken, ylim=c(-2,2), main = "Unshrunken MA plot")                                              
plotMA(resIHW, ylim=c(-2,2), main = "LFC MA plot")                                                            

```

## Significant DE genes
The DE genes are cut-off at a adjusted p-value of 0.1 and a log2FoldChange of 1.
```{r sig_genes,message=FALSE, warning=FALSE}

#Creating a tibble of the results
resIHW_tb <- resIHW %>%  data.frame() %>%  rownames_to_column(var="gene_id")%>%  as_tibble()

#Setting thresholds
padj.cutoff <- 0.2                                                                                             
log2FoldChange.cutoff.down <- -1
log2FoldChange.cutoff.up <- 1

#Selection of down and up-regulated DEG's 

sigIHW_down <- resIHW_tb %>%                                                                                
  filter(log2FoldChange < log2FoldChange.cutoff.down) %>%
  filter(padj < padj.cutoff)

sigIHW_up <- resIHW_tb %>%                                                                                        
  filter(log2FoldChange > log2FoldChange.cutoff.up) %>%
  filter(padj < padj.cutoff)

sigIHW <- rbind(sigIHW_down,sigIHW_up)                                                                          
rownames(sigIHW) <- sigIHW$gene_id

#Getting significant DE gene list + log2foldchange
CRC_gene <- subset(CRC_counts_table_gene, select = c(gene_id, gene_name))
CRC_gene_sub <- CRC_gene[CRC_gene$gene_id %in% rownames(sigIHW),]
sigIHW <- cbind(sigIHW, gene_name = CRC_gene_sub$gene_name)
sigIHW <- subset(sigIHW, select = c(log2FoldChange,gene_id, gene_name))

#write.table(sigIHW_up, file="sigIHW_up.txt", sep="\t", quote=F, col.names=NA)
#write.table(sigIHW, file="sigIHW.txt", sep="\t", quote=F, col.names=NA)
#write.table(sigIHW_down,sep="\t", quote=F, col.names=NA, file.path(""C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/output_data""))


```   

## Significant DE genes (unshrunken)
The DE genes are cut-off at a adjusted p-value of 0.1 and a log2FoldChange of 1. Here we used the unshrunken results of the genes. This results in more DE genes. 

```{r sig_genes_unshrunken,message=FALSE, warning=FALSE}

#Creating a tibble of the unsrhunken results
resIHW_tb_unshrunken <- resIHW_unshrunken %>%   data.frame() %>%   rownames_to_column(var="gene_id")%>%   as_tibble()

#Setting thresholds
padj.cutoff <- 0.1
log2FoldChange.cutoff.down <- -1 
log2FoldChange.cutoff.up <- 1

sigIHW_down_unshrunken <- resIHW_tb_unshrunken %>%
  filter(log2FoldChange < log2FoldChange.cutoff.down) %>%
  filter(padj < padj.cutoff)
sigIHW_up_unshrunken <- resIHW_tb_unshrunken %>%
  filter(log2FoldChange > log2FoldChange.cutoff.up) %>%
  filter(padj < padj.cutoff)

sigIHW_unshrunken <- rbind(sigIHW_down_unshrunken,sigIHW_up_unshrunken)
rownames(sigIHW_unshrunken) <- sigIHW_unshrunken$gene_id

#Getting significant DE gene list + applying log2foldchange
CRC_gene_sub <- CRC_gene[CRC_gene$gene_id %in% rownames(sigIHW_unshrunken),]
sigIHW_unshrunken <- cbind(sigIHW_unshrunken, gene_name = CRC_gene_sub$gene_name)
sigIHW_unshrunken <- subset(sigIHW_unshrunken, select = c(log2FoldChange,gene_id,gene_name))

#write.table(sigIHW_up_unshrunken, file="sigIHW_up_unshrunken.txt", sep="\t", quote=F, col.names=NA)
#write.table(sigIHW_unshrunken, file="sigIHW_unshrunken.txt", sep="\t", quote=F, col.names=NA)
#write.table(sigIHW_down_unshrunken,sep="\t", quote=F, col.names=NA, file.path("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/output_data"))




```   

## Volcano plotting
```{r Volcano_plotting, fig.height=10, fig.width=10,message=FALSE, warning=FALSE }

resIHW_join <- merge (x = CRC_gene, y= resIHW_tb, by= "gene_id")
resIHW_join_unshrunken <- merge (x = CRC_gene, y = resIHW_tb_unshrunken, by= "gene_id")

EnhancedVolcano(resIHW_join,
                lab = resIHW_join$gene_name,
                x = 'log2FoldChange',
                y = 'padj',
                ylim = c(0,8),
                drawConnectors = TRUE,
                pCutoff = 0.05, 
                FCcutoff = 1
                )
EnhancedVolcano(resIHW_join_unshrunken,
                lab = resIHW_join_unshrunken$gene_name,
                x = 'log2FoldChange',
                y = 'padj',
                ylim = c(0,8),
                drawConnectors = TRUE,
                pCutoff = 0.05, 
                FCcutoff = 1
                )
```


## DE genes heatmap
Need to change the colors of to top_annotation. 
```{r Heatmap,message=FALSE, warning=FALSE}
library(ComplexHeatmap)
setwd("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis/Innsbruck_project/Analysis/Saved_files")

normalized_counts <- read.table("normalized_counts_2.txt")                                                          #Load in normalized_counts
normalized_counts <- cbind(normalized_counts, gene_id = row.names(normalized_counts))                                 
normalized_counts <- merge (x = CRC_gene, y= normalized_counts, by= "gene_id")                                      #Merge df's by gene_id
normalized_counts <- normalized_counts[normalized_counts$gene_id %in% sigIHW$gene_id ,]               #Select significant genes
row.names(normalized_counts) <- normalized_counts$gene_name
normalized_counts <- subset(normalized_counts, select = -c(gene_id, gene_name))                       #Remove gene_id and gene_name
normalized_counts <- t(scale(t(normalized_counts)))                                                   #Scaling and transposing normalized_counts


Heatmap(normalized_counts,name = "Z-score", show_row_names = FALSE, cluster_rows = FALSE,                   
        top_annotation = HeatmapAnnotation("Response" = CRC_annotation$response))                     #Plotting the heatmap
```
  
  
  
  
# GO Analysis
  
## Setup library

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(clusterProfiler)
library(enrichplot)
library(ggplot2)
library(R.utils)

R.utils::setOption("clusterProfiler.download.method","auto")

#set the desired organism here
organism = "org.Hs.eg.db"
library(organism, character.only = TRUE)

```


```{r loading dataframe and prepare input, echo = FALSE, include = FALSE}
sig_down <- sigIHW_down
sig_down <- data.frame(sig_down, row.names = sig_down$gene_id)                  #set row_names -> sample names
sig_down <- subset(sig_down, select = -(gene_id))                               #removal total column

#write.csv(sig_down,sep="\t", quote=F, col.names=NA, file.path("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis/Innsbruck_project/Analysis", "sigIHW_down_2.csv"))

sig_down <- read.csv("sigIHW_down_2.csv", header = TRUE)

original_gene_list <- sig_down$log2FoldChange                                          
names(original_gene_list) <- sig_down$X                                         #name the vector
gene_list<-na.omit(original_gene_list)                                          #omit any NA values 
gene_list = sort(gene_list, decreasing = TRUE)                                  #sort the list in decreasing order (required for clusterProfiler)

```

```{r Gene set Enrichtment, echo= FALSE, include= FALSE}

gse <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "ENSEMBL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Hs.eg.db, 
             pAdjustMethod = "none")

```

```{r Enrichment Map, warning= FALSE, message = FALSE}
#plotting gene enrichment
dotplot(gse, showCategory=10, split=".sign") + facet_grid(.~.sign)
cnetplot(gse, categorySize="pvalue", foldChange=gene_list, showCategory = 3)
ridgeplot(gse) + labs(x = "enrichment distribution")

compare_cluster_GO_emap <- enrichplot::pairwise_termsim(gse, semData = gse)
emapplot(compare_cluster_GO_emap, showCategory = 10)



```





```{r Prepare input KEGG, echo= FALSE, include=FALSE}
#convert gene IDs for gseKEGG function, lose some genes here because not all IDs will be converted
ids<-bitr(names(original_gene_list), fromType = "ENSEMBL", toType = "ENTREZID", OrgDb= "org.Hs.eg.db")

#remove duplicate IDS (here I use "ENSEMBL", but it should be whatever was selected as keyType)
ids = ids[!duplicated(ids[c("ENSEMBL")]),]

#create a new dataframe mapped_genes which has only the genes which were successfully mapped using the bitr function above
mapped_genes = sig_down[sig_down$X %in% ids$ENSEMBL,]

#create a new column in mapped_genes with the corresponding ENTREZ IDs
mapped_genes$Y = ids$ENTREZID

#create a vector of the gene unuiverse
kegg_gene_list <- mapped_genes$log2FoldChange

#cnme vector with ENTREZ ids
names(kegg_gene_list) <- mapped_genes$Y

#omit any NA values 
kegg_gene_list<-na.omit(kegg_gene_list)

#sort the list in decreasing order (required for clusterProfiler)
kegg_gene_list = sort(kegg_gene_list, decreasing = TRUE)

```

```{r Create gseKEGG object, echo=FALSE, include=FALSE}
kk2 <- gseKEGG(geneList     = kegg_gene_list,
               organism     = "hsa",
               nPerm        = 10000,
               minGSSize    = 0,
               maxGSSize    = 800,
               pvalueCutoff = 0.5,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")
```

```{r Dotplot, warning= FALSE, message= FALSE}
#KEGG analysis plots
cnetplot(kk2, categorySize="pvalue", foldChange=gene_list)

compare_cluster_GO_KEGG <- enrichplot::pairwise_termsim(kk2, semData = kk2)
emapplot(compare_cluster_GO_KEGG, showCategory = 10)

dotplot(kk2, showCategory = 10, title = "Enriched Pathways" , split=".sign") + facet_grid(.~.sign)

```
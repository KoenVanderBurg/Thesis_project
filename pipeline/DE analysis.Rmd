  ---
  title: "DE analysis"
  author: "Koen van der Burg"
  date: "19/08/2021"
  output: html_document
  ---

# DE analysis

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(RColorBrewer)
library(DEGreport)
library(ggplot2)
library(ggrepel)
library(devtools)
library(ggbiplot)
library(readxl)
library(IHW)
library(pheatmap)
library(EnhancedVolcano)
library(DESeq2)
library(Glimma)
library(tidyr)
library(ComplexHeatmap)
```

## Reading in tables and modifying them
```{r CRC_loading,message=FALSE, warning=FALSE}
setwd("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/input_data")

#reading in Counts_table (>50% > 200.000)
CRC_counts_table <- read.table("Counts_table_DeSeq")
CRC_annotation <- read.table("Annotation_table")
CRC_counts_table_gene <- read.table("salmon.merged.gene_counts.tsv") 

#modifying annotation table
CRC_annotation$gender <-  recode(CRC_annotation$gender,"1" = "Male", "2" = "Female")
CRC_annotation$response <- recode(CRC_annotation$response, "0" = "No_relapse", "1" = "Relapse")
CRC_annotation <- CRC_annotation[CRC_annotation$sample %in% colnames(CRC_counts_table),]                #removal samples that don't have 200.000 counts
CRC_annotation <- data.frame(CRC_annotation, row.names = CRC_annotation$sample)                         #set row_names -> sample names
CRC_annotation <- subset(CRC_annotation, select = c(response,gender,min_tumor_cell_content))            #removal sample column

#remove genes that have <2 total count in row
CRC_counts_table <- cbind(CRC_counts_table, total = rowSums(CRC_counts_table))                          #create column with total row_counts
CRC_counts_table <- subset(CRC_counts_table, total > 1)                                                 #remove rows(genes) with less than 2 counts
CRC_counts_table <- subset(CRC_counts_table, select = -(total))                                         #removal total column

#ensemble version removal and removal of PAR_Y genes.
CRC_counts_table = CRC_counts_table[!grepl("_Y$",rownames(CRC_counts_table)),]                          #remove rows that end with the PAR_Y gene_id
CRC_counts_table$row_names <- row.names(CRC_counts_table)                                               #set row_names to column_names
CRC_counts_table$row_names <- gsub('(\\.).*', '', CRC_counts_table$row_names)                           #change row_names by removing ensemble ID
CRC_counts_table <- as.data.frame(CRC_counts_table, row.names = CRC_counts_table$row_names)             #convert back to original state
CRC_counts_table <- subset(CRC_counts_table, select = -(row_names))                                     #removal of row_names column
CRC_counts_table <- as.matrix(round(CRC_counts_table, 0))                                               #rounding counts to remove decimals
```


## Pre-check DESeq2 
```{r check, results='hide',message=FALSE, warning=FALSE}

#check if samples both in counts_table and annotation table, and amount of samples is equal.
table(colnames(CRC_counts_table) %in% rownames(CRC_annotation)) 
table(colnames(CRC_counts_table) == rownames(CRC_annotation))

```

## Creating DESeq2 object
Creating a DESeq2 object, from here we create a normalized counts table. The created dds object which is used later on for PCA plotting and heat map.
```{r normalized_counts,message=FALSE, warning=FALSE}

#creating DESeq2Dataset object and normalized_counts file.
dds <- DESeqDataSetFromMatrix(countData = round(CRC_counts_table), colData = CRC_annotation, design = ~ response)
dds <- estimateSizeFactors(dds)                                                                         #median of ratios method of normalization
normalized_counts <- counts(dds, normalized=TRUE)                                                       #retrieving normalized counts matrix


#interactive plotting
#glimmaMDS(dds)         


#creation of normalized_counts file
#write.table(normalized_counts, file="normalized_counts.txt", sep="\t", quote=F, col.names=NA, file.path ("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/output_data"))  

```


## PCA plots and correlation heatmap
Coloring on heat map needs to be changed. 
```{r QC,message=FALSE, warning=FALSE}

rld <- vst(dds, blind=TRUE)                                                                         #transform counts for data visualization.
 
plotPCA(rld, intgroup="response")                                                                   #PCA plot: Response    
plotPCA(rld, intgroup="gender")                                                                     #PCA plot: Gender
plotPCA(rld, intgroup= "min_tumor_cell_content")                                                    #PCA plot: Min tumor cell

##Heatmap
rld_mat <- assay(rld)                                                                               #extract the r-log matrix from the object
rld_cor <- cor(rld_mat)                                                                             #compute pairwise correlation values
CRC_annotation_heatmap <- subset(CRC_annotation, select = (response))                               
pheatmap(rld_cor, annotation_col = CRC_annotation_heatmap, main = "Pairwise correlation values", )  #plot heat map using the correlation matrix + metadata object
```

## DESeq2 analysis
Running the DESeq2 analysis, results derived from Independent Hypothesis Testing (IHW), using a log fold shrinkage. 
```{r DESeq2,message=FALSE, warning=FALSE}
dds <- DESeq(dds) 
resIHW_unshrunken <- results(dds, filterFun = ihw)                                               #extracting results using IHW
resIHW <- lfcShrink(dds, coef= "response_Relapse_vs_No_relapse" , type = "normal")               #applying log fold change shrinkage
```

## Dispersion and MA plots
```{r MAplot,message=FALSE, warning=FALSE}
#Plot dispersion estimates
plotDispEsts(dds, main = "Dispersion plot")

#MA Plot, colored genes are identified as significantly DE
plotMA(resIHW_unshrunken, ylim=c(-2,2), main = "Unshrunken MA plot")                                              
plotMA(resIHW, ylim=c(-2,2), main = "LFC MA plot")                                                                

```

## Significant DE genes
The DE genes are cut-off at a adjusted p-value of 0.1 and a log2FoldChange of 1.
```{r sig_genes,message=FALSE, warning=FALSE}

#Creating a tibble of the results
resIHW_tb <- resIHW %>% data.frame() %>% rownames_to_column(var="gene_id") %>% as_tibble()

#Setting thresholds
padj.cutoff <- 0.05                                                                                               
log2FoldChange.cutoff.down <- -1 
log2FoldChange.cutoff.up <- 1

#Subset the tibble to keep only DEG's 
sigIHW_down <- resIHW_tb %>%                                                                   #selection of down_regulated genes
  filter(log2FoldChange < log2FoldChange.cutoff.down) %>%
  filter(padj < padj.cutoff)
sigIHW_up <- resIHW_tb %>%                                                                     #selection of up_regulated genes
  filter(log2FoldChange > log2FoldChange.cutoff.up) %>%
  filter(padj < padj.cutoff)

sigIHW <- rbind(sigIHW_down,sigIHW_up)                                                         #selection of both up and down regulated genes 
rownames(sigIHW) <- sigIHW$gene_id

#Getting significant DE gene list + log2foldchange
colnames(CRC_counts_table_gene) <- CRC_counts_table_gene[1,]
CRC_counts_table_gene <- CRC_counts_table_gene[-1,]
CRC_counts_table_gene$gene_id <- gsub('(\\.).*', '', CRC_counts_table_gene$gene_id)            #Change row_names by removing ensembl ID
CRC_gene <- subset(CRC_counts_table_gene, select = c(gene_id, gene_name))
CRC_gene_sub <- CRC_gene[CRC_gene$gene_id %in% rownames(sigIHW),]
sigIHW <- cbind(sigIHW, gene_name = CRC_gene_sub$gene_name)
sigIHW <- subset(sigIHW, gene_id != "ENSG00000276778")                                         #Metazoa_SRP change removal
sigIHW <- subset(sigIHW, gene_id != "ENSG00000277270")                                                            
sigIHW <- subset(sigIHW, select = c(log2FoldChange,gene_id, gene_name))

#write.table(sigIHW_up, file="sigIHW_up.txt", sep="\t", quote=F, col.names=NA)
#write.table(sigIHW, file="sigIHW.txt", sep="\t", quote=F, col.names=NA)
write.csv(sigIHW_down,sep=" ", quote=F, col.names=NA, file.path("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/output_data", "sigIHW_down.csv"))

write.csv(sigIHW_up,sep=" ", quote=F, col.names=NA, file.path("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/output_data", "sigIHW_up.csv"))

#setwd("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis/Innsbruck_project/Analysis/Saved_files")
#write.csv(sigIHW_down, sep="\t", quote=F, col.names=NA, "sigIHW_down.csv")


```   

## Significant DE genes (unshrunken)
The DE genes are cut-off at a adjusted p-value of 0.1 and a log2FoldChange of 1. Here we used the unshrunken results of the genes. This results in more DE genes. 

```{r sig_genes_unshrunken,message=FALSE, warning=FALSE}

#Creating a tibble of the un-shrunken results
resIHW_tb_unshrunken <- resIHW_unshrunken %>%   data.frame() %>%   rownames_to_column(var="gene_id")%>%   as_tibble()

#Setting thresholds
padj.cutoff <- 0.05
log2FoldChange.cutoff.down <- -1 
log2FoldChange.cutoff.up <- 1

#Subset the tibble to keep only DEG's 
sigIHW_down_unshrunken <- resIHW_tb_unshrunken %>%
  filter(log2FoldChange < log2FoldChange.cutoff.down) %>%
  filter(padj < padj.cutoff)
sigIHW_up_unshrunken <- resIHW_tb_unshrunken %>%
  filter(log2FoldChange > log2FoldChange.cutoff.up) %>%
  filter(padj < padj.cutoff)

sigIHW_unshrunken <- rbind(sigIHW_down_unshrunken,sigIHW_up_unshrunken)
rownames(sigIHW_unshrunken) <- sigIHW_unshrunken$gene_id

#Getting significant DE gene list + applying log2foldchange
CRC_gene_sub <- CRC_gene[CRC_gene$gene_id %in% rownames(sigIHW_unshrunken),]
sigIHW_unshrunken <- cbind(sigIHW_unshrunken, gene_name = CRC_gene_sub$gene_name)

#row.names(sigIHW_unshrunken) <- sigIHW_unshrunken$gene_name                                                        #‘Metazoa_SRP’, ‘Y_RNA’ duplicates
sigIHW_unshrunken <- subset(sigIHW_unshrunken, select = c(log2FoldChange,gene_id,gene_name))
#write.table(sigIHW_down_unshrunken, file="sigIHW_down_unshrunken.txt", sep="\t", quote=F, col.names=NA)
#write.table(sigIHW_up_unshrunken, file="sigIHW_up_unshrunken.txt", sep="\t", quote=F, col.names=NA)
#write.table(sigIHW_unshrunken, file="sigIHW_unshrunken.txt", sep="\t", quote=F, col.names=NA)



```   

## Volcano plotting
```{r Volcano_plotting, fig.height=10, fig.width=10,message=FALSE, warning=FALSE }

resIHW_join <- merge (x = CRC_gene, y= resIHW_tb, by= "gene_id")
resIHW_join_unshrunken <- merge (x = CRC_gene, y = resIHW_tb_unshrunken, by= "gene_id")

EnhancedVolcano(resIHW_join,
                lab = resIHW_join$gene_name,
                x = 'log2FoldChange',
                y = 'padj',
                ylim = c(0,8),
                drawConnectors = TRUE,
                pCutoff = 0.05, 
                FCcutoff = 1
                )


EnhancedVolcano(resIHW_join_unshrunken,
                lab = resIHW_join_unshrunken$gene_name,
                x = 'log2FoldChange',
                y = 'padj',
                ylim = c(0,8),
                drawConnectors = TRUE,
                pCutoff = 0.05, 
                FCcutoff = 1
                )
```


## DE genes heatmap
Need to change the colors of to top_annotation. 
```{r Heatmap,message=FALSE, warning=FALSE}
setwd("C:/Users/koenv/OneDrive/Documenten/Universiteit/Bio-informatica Jaar 3/Thesis_project/input_data")
normalized_counts <- read.table("normalized_counts.txt")                                                #load in normalized_counts
normalized_counts <- cbind(normalized_counts, gene_id = row.names(normalized_counts))                             
normalized_counts <- merge (x = CRC_gene, y= normalized_counts, by= "gene_id")                          #merge dataframes by gene_id
normalized_counts <- normalized_counts[normalized_counts$gene_id %in% sigIHW$gene_id ,]                 #select significant genes
normalized_counts <- subset(normalized_counts, gene_id != "ENSG00000274701")                            #Metazoa_SRP change removal
normalized_counts <- subset(normalized_counts, gene_id != "ENSG00000277250")              
row.names(normalized_counts) <- normalized_counts$gene_name
normalized_counts <- subset(normalized_counts, select = -c(gene_id, gene_name))                         #remove gene_id and gene_name
normalized_counts <- t(scale(t(normalized_counts)))                                                     #scaling and transposing normalized_counts

Heatmap(normalized_counts,name = "Z-score", show_row_names = FALSE, cluster_rows = FALSE,                   
        top_annotation = HeatmapAnnotation("Response" = CRC_annotation$response))                       #plotting the heat-map
```


